<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Control de Ingreso ‚Äì Convenci√≥n 2025</title>
  <link rel="icon" type="image/ico" href="Logo_Comunidad.ico" />
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Nunito', sans-serif;
      background-color: #f9f9fc;
      color: #333;
      text-align: center;
      padding: 20px;
    }
    header { margin-bottom: 30px; }
    header img { width: 120px; margin-bottom: 10px; }
    h1 { font-size: 1.8rem; color: #444; margin-bottom: 5px; }
    p.subtitulo { font-size: 1rem; color: #666; margin-top: 0; }

    #reader {
      width: 320px;
      margin: auto;
      border: 3px dashed #aaa;
      border-radius: 14px;
      background: #fff;
      padding: 10px;
      transition: border-color 160ms ease, box-shadow 160ms ease;
      box-shadow: 0 0 0 0 rgba(0,0,0,0);
    }
    /* Estados del frame */
    .frame-busy   { border-color: #2d6cdf; box-shadow: 0 0 0 4px rgba(45,108,223,0.15); }
    .frame-ok     { border-color: #28a745; box-shadow: 0 0 0 4px rgba(40,167,69,0.15); }
    .frame-warn   { border-color: #ffc107; box-shadow: 0 0 0 4px rgba(255,193,7,0.2); }
    .frame-error  { border-color: #dc3545; box-shadow: 0 0 0 4px rgba(220,53,69,0.2); }

    #result {
      margin-top: 20px;
      font-size: 1.1rem;
      font-weight: 700;
      padding: 16px;
      border-radius: 10px;
      display: inline-block;
      max-width: 90%;
    }
    .ok    { background-color: #d4edda; color: #155724; }
    .error { background-color: #f8d7da; color: #721c24; }
    .warn  { background-color: #fff3cd; color: #856404; }

    #scan-again {
      margin-top: 14px;
      padding: 10px 16px;
      font-size: 1rem;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      background: #2d6cdf;
      color: #fff;
      display: none;
    }
    #scan-again:active { transform: scale(0.98); }

    footer {
      margin-top: 40px;
      font-size: 0.85rem;
      color: #999;
    }
  </style>
</head>
<body>
  <header>
    <img src="Logo_Comunidad.jpg" alt="Logo Comunidad Marta y Mar√≠a">
    <h1>Control de Ingreso</h1>
    <p class="subtitulo">Convenci√≥n 2025 ‚Äì Fundaci√≥n Marta y Mar√≠a</p>
  </header>

  <div id="reader" aria-live="polite"></div>
  <div id="result" aria-live="assertive"></div>
  <button id="scan-again">üì∑ Escanear otro c√≥digo</button>

  <footer>
    ‚ô• Desarrollado con cari√±o para la Fundaci√≥n Marta y Mar√≠a ‚ô•
  </footer>

  <script>
    // ------------------ Utilidades UI ------------------
    const readerDiv   = document.getElementById('reader');
    const resultDiv   = document.getElementById('result');
    const scanAgainBtn= document.getElementById('scan-again');

    function setFrameState(stateClass) {
      readerDiv.classList.remove('frame-busy','frame-ok','frame-warn','frame-error');
      if (stateClass) readerDiv.classList.add(stateClass);
    }

    const showResult = (message, type = 'ok') => {
      resultDiv.innerText = message;
      resultDiv.className = type;
      // Mapear tipo ‚Üí frame + vibraci√≥n
      if (type === 'ok') {
        setFrameState('frame-ok');
        navigator.vibrate?.(80);               // breve vibraci√≥n positiva
      } else if (type === 'warn') {
        setFrameState('frame-warn');
        navigator.vibrate?.([120, 60, 120]);   // doble pulso
      } else {
        setFrameState('frame-error');
        navigator.vibrate?.([60, 60, 60, 60, 200]); // patr√≥n de error
      }
    };

    // Beep con Web Audio API
    function beep(duration = 120, frequency = 880, volume = 0.2) {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain); gain.connect(ctx.destination);
        gain.gain.value = volume;
        osc.frequency.value = frequency;
        osc.type = 'sine';
        osc.start();
        setTimeout(() => { osc.stop(); ctx.close(); }, duration);
      } catch (e) {}
    }

    // ------------------ L√≥gica de escaneo ------------------
    let scanner;
    let locked = false;
    let useStopRestartFallback = false;

    const cameraConfig = { facingMode: "environment" };
    const scanConfig   = { fps: 10, qrbox: 250 };

    async function startScanner() {
      if (!scanner) scanner = new Html5Qrcode("reader");
      locked = false;
      setFrameState(null);
      try {
        await scanner.start(cameraConfig, scanConfig, onScanSuccess, onScanError);
      } catch (err) {
        showResult("‚ùå No se pudo iniciar la c√°mara. Revisa permisos del navegador.", 'error');
      }
    }

    async function pauseScanner() {
      if (!scanner) return;
      try {
        if (typeof scanner.pause === 'function') {
          scanner.pause(true);
          useStopRestartFallback = false;
        } else {
          await scanner.stop();
          useStopRestartFallback = true;
        }
      } catch (e) {
        try { await scanner.stop(); useStopRestartFallback = true; } catch (_e) {}
      }
    }

    async function resumeScanner() {
      resultDiv.innerText = '';
      resultDiv.className = '';
      scanAgainBtn.style.display = 'none';
      locked = false;
      setFrameState(null);
      try {
        if (useStopRestartFallback) {
          await startScanner();
        } else if (typeof scanner.resume === 'function') {
          await scanner.resume();
        } else {
          await startScanner();
        }
      } catch (e) {
        showResult("‚ùå No se pudo reanudar la c√°mara.", 'error');
      }
    }

    let lastText = null;
    let lastTime = 0;

    async function onScanSuccess(decodedText) {
      const now = Date.now();
      if (locked) return;
      if (decodedText === lastText && (now - lastTime) < 1200) return;
      lastText = decodedText; lastTime = now;

      locked = true;
      beep();                         // sonido al detectar QR
      setFrameState('frame-busy');    // feedback visual inmediato ‚Äúprocesando‚Ä¶‚Äù
      await handleScan(decodedText);  // consulta al backend y pinta resultado
      await pauseScanner();           // detener hasta confirmaci√≥n del operador
      scanAgainBtn.style.display = 'inline-block';
      scanAgainBtn.focus();
    }

    function onScanError(_msg) { /* silencioso */ }

    // Consulta a Apps Script
    const handleScan = async (id) => {
      const url = `https://script.google.com/macros/s/AKfycbwSYjNvXHbAuVa-Cv_cdEtJOf_zgo6ZU2Y3qgIv5H2e24PucyBxcsmYIhuaQE1jckaK/exec?id=${encodeURIComponent(id)}`;
      try {
        const response = await fetch(url);
        const text = await response.text();

        if (text.includes("‚úÖ"))      showResult(text, 'ok');
        else if (text.includes("‚ö†Ô∏è")) showResult(text, 'warn');
        else                          showResult(text, 'error');
      } catch (e) {
        showResult("‚ùå Error al contactar al servidor.", 'error');
      }
    };

    scanAgainBtn.addEventListener('click', resumeScanner);

    // Arranque
    startScanner();
  </script>
</body>
</html>
